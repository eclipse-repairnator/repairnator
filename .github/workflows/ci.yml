name: Continuous Integration for Repairnator

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  repairnator-core:
    name: repairnator-core
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'maven'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cloc shunit2 xmlstarlet libgomp1
        sudo npm install -g ajv-cli

    - name: Check Maven Home
      run: |
        # Ensure /usr/share/maven exists as expected by the scripts
        if [ ! -d "/usr/share/maven" ]; then
          echo "/usr/share/maven not found. Creating symlink from $M2_HOME or using mvn location."
          if [ -n "$M2_HOME" ]; then
            sudo ln -s "$M2_HOME" /usr/share/maven
          else
             sudo ln -s /usr/share/apache-maven-* /usr/share/maven || true
          fi
        fi

    - name: Run Test Script
      env:
        TEST_PATH: src/repairnator-core/
        GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
      run: |
        bash ./.ci/ci-run.sh

  repairnator-realtime:
    name: repairnator-realtime
    runs-on: ubuntu-latest
    needs: repairnator-core

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'maven'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cloc shunit2 xmlstarlet libgomp1
        sudo npm install -g ajv-cli

    - name: Check Maven Home
      run: |
        # Ensure /usr/share/maven exists as expected by the scripts
        if [ ! -d "/usr/share/maven" ]; then
          echo "/usr/share/maven not found. Creating symlink from $M2_HOME or using mvn location."
          if [ -n "$M2_HOME" ]; then
            sudo ln -s "$M2_HOME" /usr/share/maven
          else
             sudo ln -s /usr/share/apache-maven-* /usr/share/maven || true
          fi
        fi

    - name: Run Test Script
      env:
        TEST_PATH: src/repairnator-realtime/
        TEST_LIST: "**"
        GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
      run: |
        bash ./.ci/ci-run-with-core-pipeline.sh

  repairnator-jenkins-plugin:
    name: repairnator-jenkins-plugin
    runs-on: ubuntu-latest
    needs: repairnator-realtime

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'maven'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cloc shunit2 xmlstarlet libgomp1
        sudo npm install -g ajv-cli

    - name: Check Maven Home
      run: |
        # Ensure /usr/share/maven exists as expected by the scripts
        if [ ! -d "/usr/share/maven" ]; then
          echo "/usr/share/maven not found. Creating symlink from $M2_HOME or using mvn location."
          if [ -n "$M2_HOME" ]; then
            sudo ln -s "$M2_HOME" /usr/share/maven
          else
             sudo ln -s /usr/share/apache-maven-* /usr/share/maven || true
          fi
        fi

    - name: Run Test Script
      env:
        TEST_PATH: src/repairnator-jenkins-plugin/
        GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
      run: |
        bash ./.ci/ci-run.sh

  repairnator-maven-repair:
    name: repairnator-maven-repair
    runs-on: ubuntu-latest
    needs: repairnator-jenkins-plugin

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'maven'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cloc shunit2 xmlstarlet libgomp1
        sudo npm install -g ajv-cli

    - name: Check Maven Home
      run: |
        # Ensure /usr/share/maven exists as expected by the scripts
        if [ ! -d "/usr/share/maven" ]; then
          echo "/usr/share/maven not found. Creating symlink from $M2_HOME or using mvn location."
          if [ -n "$M2_HOME" ]; then
            sudo ln -s "$M2_HOME" /usr/share/maven
          else
             sudo ln -s /usr/share/apache-maven-* /usr/share/maven || true
          fi
        fi

    - name: Run Test Script
      env:
        TEST_PATH: src/maven-repair/
        TEST_LIST: "**"
        GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
      run: |
        bash ./.ci/ci-maven-repair.sh

  repairnator-pipeline:
    name: repairnator-pipeline
    runs-on: ubuntu-latest
    needs: repairnator-maven-repair

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'maven'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cloc shunit2 xmlstarlet libgomp1
        sudo npm install -g ajv-cli

    - name: Check Maven Home
      run: |
        # Ensure /usr/share/maven exists as expected by the scripts
        if [ ! -d "/usr/share/maven" ]; then
          echo "/usr/share/maven not found. Creating symlink from $M2_HOME or using mvn location."
          if [ -n "$M2_HOME" ]; then
            sudo ln -s "$M2_HOME" /usr/share/maven
          else
             sudo ln -s /usr/share/apache-maven-* /usr/share/maven || true
          fi
        fi

    - name: Run Test Script
      env:
        TEST_PATH: src/repairnator-pipeline/
        TEST_LIST: "**"
        GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
      run: |
        bash ./.ci/ci-run-with-core.sh